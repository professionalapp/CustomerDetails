@page
@model CustomerDetails.Pages.EmployeesModel
@{
    ViewData["Title"] = "Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„";
}

@section Styles {
    <style>
        .image-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .image-upload-container:hover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .image-preview {
            position: relative;
            display: inline-block;
            margin-bottom: 10px;
        }

        .preview-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .remove-image {
            position: absolute;
            top: -10px;
            right: -10px;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .upload-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upload-buttons .btn {
            min-width: 100px;
            padding: 8px 15px;
            font-size: 14px;
        }

        .upload-status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 5px;
            display: none;
            font-size: 12px;
        }

        .upload-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-status.uploading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
}

<div class="container mt-4 fade-in">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4" style="color: #4C7EFF; font-family: 'Segoe UI', sans-serif;">
                Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ğŸ”
            </h1>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="d-flex justify-content-end mb-2">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showAllToggle">
                    <label class="form-check-label" for="showAllToggle">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</label>
                </div>
            </div>
            <div class="search-container flex-grow-1 mb-3">
                <input type="text" id="searchInput" class="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..."
                    autocomplete="off" />
                <i class="fas fa-search search-icon"></i>
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«
                </small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="searchContent">
                <div class="text-center py-5">
                    <div class="search-welcome">
                        <i class="fas fa-search fa-4x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">Ø¨Ø­Ø«</h3>
                        <p class="text-muted mb-4">Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" class="img-fluid" id="modalImage" alt="Employee Image">
            </div>
        </div>
    </div>
</div>

<!-- Edit Employee Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEmployeeForm">
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                        <input class="form-control" id="edit_name" type="text" pattern="[Ø£-ÙŠ\s]+"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø§Ø³Ù… Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·" />
                        <div class="invalid-feedback" id="editNameError">
                            Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„Ø¹Ù…Ø±</label>
                        <input type="text" class="form-control" id="edit_age" pattern="[0-9]+"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ø¹Ù…Ø± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" />
                        <div class="invalid-feedback" id="editAgeError">
                            Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input class="form-control" id="edit_address" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                        <select class="form-select" id="edit_identityType">
                            <option value="Ù‡ÙˆÙŠØ© Ø£Ø±Ø¯Ù†ÙŠØ©">Ù‡ÙˆÙŠØ© Ø£Ø±Ø¯Ù†ÙŠØ©</option>
                            <option value="Ø¬ÙˆØ§Ø² Ø³ÙØ±">Ø¬ÙˆØ§Ø² Ø³ÙØ±</option>
                            <option value="Ø¥Ù‚Ø§Ù…Ø©">Ø¥Ù‚Ø§Ù…Ø©</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                        <input class="form-control" id="edit_identityName" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
                        <div class="image-upload-container">
                            <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                            <div id="editImagePreview" class="image-preview" style="display: none;">
                                <img id="editPreviewImg" src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" class="preview-image">
                                <button type="button" class="btn btn-sm btn-danger remove-image"
                                    onclick="removeEditImage()">
                                    <i class="fas fa-times"></i> Ø­Ø°Ù
                                </button>
                            </div>

                            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© -->
                            <div id="editImageUploadButtons" class="upload-buttons">
                                <button type="button" class="btn btn-primary" onclick="selectEditImageFromGallery()">
                                    <i class="fas fa-images"></i> Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ
                                </button>
                            </div>

                            <!-- Ø­Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ÙÙŠ -->
                            <input type="file" id="editImageInput" accept="image/*" style="display: none;"
                                onchange="handleEditImageSelect(event)">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                <button type="button" class="btn btn-primary" id="saveEditBtn">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Transaction Modal -->
<div class="modal fade" id="addTxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTxForm">
                    <div class="mb-2">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                        <select class="form-select" id="tx_type">
                            <option value="Ø³Ø­Ø¨">Ø³Ø­Ø¨</option>
                            <option value="Ø¥ÙŠØ¯Ø§Ø¹">Ø¥ÙŠØ¯Ø§Ø¹</option>
                            <option value="ØªØ­ÙˆÙŠÙ„ Ø±Ø§ØªØ¨">ØªØ­ÙˆÙŠÙ„ Ø±Ø§ØªØ¨</option>
                            <option value="Ù…ÙƒØ§ÙØ£Ø©">Ù…ÙƒØ§ÙØ£Ø©</option>
                            <option value="Ø®ØµÙ…">Ø®ØµÙ…</option>
                            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ©</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="text" class="form-control" id="tx_amount" pattern="[0-9]+(\.[0-9]+)?"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" required />
                        <div class="invalid-feedback" id="txAmountError">
                            Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
                        <input class="form-control" id="tx_box" pattern="[0-9]+"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" />
                        <div class="invalid-feedback" id="txBoxError">
                            Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„ÙˆÙ‚Øª</label>
                        <input class="form-control" value="Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" disabled />
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input class="form-control" id="tx_desc" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                <button type="button" class="btn btn-success" id="saveTxBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTxForm">
                    <input type="hidden" id="edit_tx_documentId">
                    <div class="mb-2">
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label>
                        <select class="form-select" id="edit_tx_type">
                            <option value="Ø³Ø­Ø¨">Ø³Ø­Ø¨</option>
                            <option value="Ø¥ÙŠØ¯Ø§Ø¹">Ø¥ÙŠØ¯Ø§Ø¹</option>
                            <option value="ØªØ­ÙˆÙŠÙ„ Ø±Ø§ØªØ¨">ØªØ­ÙˆÙŠÙ„ Ø±Ø§ØªØ¨</option>
                            <option value="Ù…ÙƒØ§ÙØ£Ø©">Ù…ÙƒØ§ÙØ£Ø©</option>
                            <option value="Ø®ØµÙ…">Ø®ØµÙ…</option>
                            <option value="Ø³Ù„ÙØ©">Ø³Ù„ÙØ©</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
                        <input type="text" class="form-control" id="edit_tx_amount" pattern="[0-9]+(\.[0-9]+)?"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" required />
                        <div class="invalid-feedback" id="editTxAmountError">
                            Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</label>
                        <input class="form-control" id="edit_tx_box" pattern="[0-9]+"
                            title="ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·" />
                        <div class="invalid-feedback" id="editTxBoxError">
                            Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input class="form-control" id="edit_tx_desc" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                <button type="button" class="btn btn-primary" id="saveEditTxBtn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Summary Modal -->
<div class="modal fade" id="txSummaryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="txSummaryBody">
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let searchTimeout;
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchContent = document.getElementById('searchContent');

        searchInput.addEventListener('input', function () {
            const query = this.value.trim();
            if (query.length === 0) { searchResults.style.display = 'none'; return; }
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => performSearch(query), 300);
        });

        document.addEventListener('click', function (e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/employees/search?query=${encodeURIComponent(query)}`);
                const results = await response.json();
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                } else {
                    searchResults.innerHTML = results.map(e => `
                                                                                                                            <div class="search-result-item" onclick="selectEmployee('${e.id}')">
                                                                                                                                <div class="search-result-name">${e.name}</div>
                                                                                                                                <div class="search-result-details">
                                                                                                                                    Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${e.id} | Ø§Ù„Ø¹Ù…Ø±: ${e.age} Ø³Ù†Ø© | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${e.joinDate}
                                                                                                                                </div>
                                                                                                                            </div>
                                                                                                                        `).join('');
                }
                searchResults.style.display = 'block';
            } catch (err) {
                console.error(err);
                searchResults.innerHTML = '<div class="no-results">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«</div>';
                searchResults.style.display = 'block';
            }
        }

        function selectEmployee(id) {
            searchInput.value = id;
            searchResults.style.display = 'none';
            loadEmployee(id);
        }

        async function loadEmployee(id) {
            try {
                searchContent.innerHTML = `
                                                                                                                                        <div class="text-center py-4">
                                                                                                                                            <div class="spinner-border text-primary" role="status">
                                                                                                                                                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                                                                                                                                            </div>
                                                                                                                                            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„...</p>
                                                                                                                                        </div>
                                                                                                                                    `;

                const [empRes, trRes] = await Promise.all([
                    fetch(`/api/employees/${encodeURIComponent(id)}`),
                    fetch(`/api/employees/${encodeURIComponent(id)}/transactions`)
                ]);

                if (empRes.status === 404) {
                    searchContent.innerHTML = `<div class="alert alert-warning text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…ÙŠÙ„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…: <strong>${id}</strong></div>`;
                    return;
                }

                const emp = await empRes.json();
                const transactions = trRes.ok ? await trRes.json() : [];

                // store globally for modals
                window.currentEmployee = emp;

                // Calculate transaction summaries
                const totalAmount = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);

                const transactionsTable = transactions.length > 0 ? `
                                                                                                            <div class="card mt-4">
                                                                                                                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                                                                                                    <h4 class="mb-0 text-white">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ğŸ’³</h4>
                                                                                                                    <button class="btn btn-sm btn-light" title="Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª" onclick="openTxSummary()">
                                                                                                                        <i class="fas fa-chart-pie"></i>
                                                                                                                    </button>
                                                                                                                </div>
                                                                                                                <div class="card-body">
                                                                                                                    <!-- Transaction Total -->
                                                                                                                    <div class="row mb-3 text-center">
                                                                                                                        <div class="col-12">
                                                                                                                            <div class="p-2 border rounded bg-light">
                                                                                                                                <strong>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:</strong> <span class="fw-bold">${totalAmount.toLocaleString()} Ø¯.Ø£</span>
                                                                                                                            </div>
                                                                                                                        </div>
                                                                                                                    </div>

                                                                                                                    <div class="table-responsive">
                                                                                                                        <table class="table table-striped table-hover">
                                                                                                                            <thead class="table-dark">
                                                                                                                                <tr>
                                                                                                                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</th>
                                                                                                                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                                                                                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                                                                                                                                    <th>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th>
                                                                                                                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                                                                                                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                                                                                                                </tr>
                                                                                                                            </thead>
                                                                                                                            <tbody>
                                                                                                                                ${transactions.map(t => `
                                                                                                                                    <tr>
                                                                                                                                        <td><span class="badge ${t.transactionType === 'Ø¥ÙŠØ¯Ø§Ø¹' ? 'bg-success' : 'bg-danger'}">${t.transactionType ?? ''}</span></td>
                                                                                                                                        <td class="${t.transactionType === 'Ø¥ÙŠØ¯Ø§Ø¹' ? 'text-success' : 'text-danger'} fw-bold">${(t.amount ?? 0).toLocaleString()}</td>
                                                                                                                                        <td>${t.transactionTime ?? ''}</td>
                                                                                                                                        <td>${t.boxNumber ?? ''}</td>
                                                                                                                                        <td>${t.description ?? ''}</td>
                                                                                                                                        <td><button class="btn btn-sm btn-info" onclick="openEditTxModal('${t.documentId}')">ØªØ¹Ø¯ÙŠÙ„</button></td>
                                                                                                                                    </tr>
                                                                                                                                `).join('')}
                                                                                                                            </tbody>
                                                                                                                        </table>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        ` : `
                                                                                                            <div class="card mt-4">
                                                                                                                <div class="card-header bg-success text-white">
                                                                                                                    <h4 class="mb-0 text-white">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ğŸ’³</h4>
                                                                                                                </div>
                                                                                                                <div class="card-body text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                                                                                                            </div>
                                                                                                        `;

                searchContent.innerHTML = `
                                                                                                                                        <div class="card mb-4">
                                                                                                                                            <div class="card-header bg-primary text-white">
                                                                                                                                                <h3 class="mb-0 text-white">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ğŸ‘¤</h3>
                                                                                                                                            </div>
                                                                                                                                            <div class="card-body">
                                                                                                                                                <div class="d-flex justify-content-end mb-3">
                                                                                                                                                    <button class="btn btn-warning me-2" onclick="openEditModal(window.currentEmployee)">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                                                                                                                                                    <button class="btn btn-success" onclick="openTxModal()">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø©</button>
                                                                                                                                                </div>
                                                                                                                                                <div class="row">
                                                                                                                                                    <div class="col-md-3"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong><br><span class="text-primary">${emp.id}</span></div>
                                                                                                                                                    <div class="col-md-3"><strong>Ø§Ù„Ø§Ø³Ù…:</strong><br><span>${emp.name}</span></div>
                                                                                                                                                    <div class="col-md-3"><strong>Ø§Ù„Ø¹Ù…Ø±:</strong><br><span>${emp.age} Ø³Ù†Ø©</span></div>
                                                                                                                                                    <div class="col-md-3"><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong><br><span>${emp.createdAt ?? ''}</span></div>
                                                                                                                                                </div>
                                                                                                                                                <div class="row mt-3">
                                                                                                                                                    <div class="col-md-6"><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong><br><span>${emp.address ?? ''}</span></div>
                                                                                                                                                    <div class="col-md-3"><strong>Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙˆÙŠØ©:</strong><br><span>${emp.identityType ?? ''}</span></div>
                                                                                                                                                </div>
                                                                                                                                                ${emp.imageUrl ? `<div class="mt-3"><img src="${emp.imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„" class="img-fluid" style="max-width:200px;border-radius:8px; cursor:pointer;" onclick="openImageModal('${emp.imageUrl}')"></div>` : ''}
                                                                                                                                            </div>
                                                                                                                                        </div>
                                                                                                                            ${transactionsTable}
                                                                                                                        `;
            } catch (err) {
                console.error(err);
                searchContent.innerHTML = `<div class="alert alert-danger text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>`;
            }
        }

        // Function to load all employees
        async function loadAllEmployees() {
            try {
                searchContent.innerHTML = `
                                                                                                                                            <div class="text-center py-4">
                                                                                                                                                <div class="spinner-border text-primary" role="status">
                                                                                                                                                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</span>
                                                                                                                                                </div>
                                                                                                                                                <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</p>
                                                                                                                                            </div>
                                                                                                                                        `;
                searchInput.style.display = 'none'; // Hide search input when showing all
                searchResults.style.display = 'none'; // Hide search results

                const response = await fetch('/api/employees'); // Use the GetAll API
                const employees = await response.json();

                if (employees.length > 0) {
                    searchContent.innerHTML = `
                                                                                                            <div class="table-responsive">
                                                                                                                <table class="table table-striped" id="employeesTable">
                                                                                                                    <thead class="table-dark">
                                                                                                                        <tr>
                                                                                                                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                                                                                                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                                                                                                                            <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                                                                                                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                                                                                                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                                                                                                            <th>Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                                                                                                            <th>ØµÙˆØ±Ø©</th>
                                                                                                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                                                                                                        </tr>
                                                                                                                    </thead>
                                                                                                                    <tbody>
                                                                                                                        ${employees.map(e => `
                                                                                                                            <tr>
                                                                                                                                <td>${e.id ?? ''}</td>
                                                                                                                                <td>${e.name ?? ''}</td>
                                                                                                                                <td>${e.age ?? ''}</td>
                                                                                                                                <td>${e.createdAt ?? ''}</td>
                                                                                                                                <td>${e.address ?? ''}</td>
                                                                                                                                <td>${(e.identityType ?? '') + (e.identityName ? ' - ' + e.identityName : '')}</td>
                                                                                                                                <td>${e.imageUrl ? `<img src="${e.imageUrl}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„" class="img-thumbnail" style="max-width:80px;border-radius:6px; cursor:pointer;" onclick="openImageModal('${e.imageUrl}')">` : ''}</td>
                                                                                                                                <td><button class="btn btn-sm btn-info" onclick="loadEmployee('${e.id}')">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button></td>
                                                                                                                            </tr>
                                                                                                                        `).join('')}
                                                                                                                    </tbody>
                                                                                                                </table>
                                                                                                            </div>
                                                                                                        `;
                } else {
                    searchContent.innerHTML = `<div class="alert alert-info text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡.</div>`;
                }
            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:', err);
                searchContent.innerHTML = `<div class="alert alert-danger text-center">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡.</div>`;
            }
        }

        // Initial welcome message
        const initialWelcomeContent = searchContent.innerHTML;

        const showAllToggle = document.getElementById('showAllToggle');
        showAllToggle.addEventListener('change', function () {
            if (this.checked) {
                loadAllEmployees();
                searchInput.value = ''; // Clear search input when showing all
                searchInput.style.display = 'none'; // Hide search input
            } else {
                searchContent.innerHTML = initialWelcomeContent; // Revert to welcome
                searchInput.style.display = 'block'; // Show search input
                searchResults.style.display = 'none'; // Hide search results
            }
        });

        // Function to open the image modal
        function openImageModal(imageUrl) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageUrl;
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
            playSound('cameraShutter.mp3'); // Play sound here
        }

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        let editSelectedImageFile = null;
        let editUploadedImageUrl = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function validateEditName() {
            const nameInput = document.getElementById('edit_name');
            const name = nameInput.value.trim();
            const isValid = /^[Ø£-ÙŠ\s]+$/.test(name);

            if (name && !isValid) {
                nameInput.classList.add('is-invalid');
                return false;
            } else {
                nameInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¹Ù…Ø± ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function validateEditAge() {
            const ageInput = document.getElementById('edit_age');
            const age = ageInput.value.trim();
            const isValid = /^[0-9]+$/.test(age);

            if (age && !isValid) {
                ageInput.classList.add('is-invalid');
                return false;
            } else {
                ageInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        function validateTxAmount() {
            const amountInput = document.getElementById('tx_amount');
            const amount = amountInput.value.trim();
            const isValid = /^[0-9]+(\.[0-9]+)?$/.test(amount);

            if (amount && !isValid) {
                amountInput.classList.add('is-invalid');
                return false;
            } else {
                amountInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        function validateTxBox() {
            const boxInput = document.getElementById('tx_box');
            const box = boxInput.value.trim();
            const isValid = /^[0-9]+$/.test(box);

            if (box && !isValid) {
                boxInput.classList.add('is-invalid');
                return false;
            } else {
                boxInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¨Ù„Øº ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        function validateEditTxAmount() {
            const amountInput = document.getElementById('edit_tx_amount');
            const amount = amountInput.value.trim();
            const isValid = /^[0-9]+(\.[0-9]+)?$/.test(amount);

            if (amount && !isValid) {
                amountInput.classList.add('is-invalid');
                return false;
            } else {
                amountInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©
        function validateEditTxBox() {
            const boxInput = document.getElementById('edit_tx_box');
            const box = boxInput.value.trim();
            const isValid = /^[0-9]+$/.test(box);

            if (box && !isValid) {
                boxInput.classList.add('is-invalid');
                return false;
            } else {
                boxInput.classList.remove('is-invalid');
                return true;
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function selectEditImageFromGallery() {
            const input = document.getElementById('editImageInput');
            input.removeAttribute('capture');
            input.click();
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function handleEditImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                editSelectedImageFile = file;
                showEditImagePreview(file);
                uploadEditImageToCloudinary(file);
            }
        }

        // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function showEditImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('editPreviewImg').src = e.target.result;
                document.getElementById('editImagePreview').style.display = 'block';
                document.getElementById('editImageUploadButtons').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function removeEditImage() {
            editSelectedImageFile = null;
            editUploadedImageUrl = null;
            document.getElementById('editImagePreview').style.display = 'none';
            document.getElementById('editImageUploadButtons').style.display = 'flex';
            document.getElementById('editImageInput').value = '';
            hideEditUploadStatus();
        }

        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Cloudinary ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        async function uploadEditImageToCloudinary(file) {
            showEditUploadStatus('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...', 'uploading');

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', 'imgupload');
                formData.append('folder', 'employees');

                const response = await fetch('https://api.cloudinary.com/v1_1/dnx3ypscu/image/upload', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    editUploadedImageUrl = data.secure_url;
                    showEditUploadStatus('ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                } else {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
                showEditUploadStatus('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
            }
        }

        // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function showEditUploadStatus(message, type) {
            let statusDiv = document.getElementById('editUploadStatus');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.id = 'editUploadStatus';
                statusDiv.className = 'upload-status';
                document.querySelector('#editEmployeeModal .image-upload-container').appendChild(statusDiv);
            }

            statusDiv.textContent = message;
            statusDiv.className = `upload-status ${type}`;
            statusDiv.style.display = 'block';
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        function hideEditUploadStatus() {
            const statusDiv = document.getElementById('editUploadStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }

        function openEditModal(emp) {
            window.currentEmployee = emp;
            document.getElementById('edit_name').value = emp.name ?? '';
            document.getElementById('edit_age').value = emp.age ?? '';
            document.getElementById('edit_address').value = emp.address ?? '';
            document.getElementById('edit_identityType').value = emp.identityType ?? ''; // Set value for dropdown
            document.getElementById('edit_identityName').value = emp.identityName ?? '';

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
            editSelectedImageFile = null;
            editUploadedImageUrl = null;

            // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (emp.imageUrl) {
                document.getElementById('editPreviewImg').src = emp.imageUrl;
                document.getElementById('editImagePreview').style.display = 'block';
                document.getElementById('editImageUploadButtons').style.display = 'none';
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
                document.getElementById('editImageUploadButtons').style.display = 'flex';
            }

            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const editNameInput = document.getElementById('edit_name');
            const editAgeInput = document.getElementById('edit_age');

            // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            editNameInput.removeEventListener('input', validateEditName);
            editNameInput.removeEventListener('blur', validateEditName);
            editAgeInput.removeEventListener('input', validateEditAge);
            editAgeInput.removeEventListener('blur', validateEditAge);

            // Ø¥Ø¶Ø§ÙØ© event listeners Ø¬Ø¯ÙŠØ¯Ø©
            editNameInput.addEventListener('input', validateEditName);
            editNameInput.addEventListener('blur', validateEditName);
            editAgeInput.addEventListener('input', validateEditAge);
            editAgeInput.addEventListener('blur', validateEditAge);

            hideEditUploadStatus();
            new bootstrap.Modal(document.getElementById('editEmployeeModal')).show();
        }

        function openTxModal() {
            // Clear previous values before opening for new transaction
            document.getElementById('tx_type').value = 'Ø³Ø­Ø¨';
            document.getElementById('tx_amount').value = '';
            document.getElementById('tx_box').value = '';
            document.getElementById('tx_desc').value = '';

            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const txAmountInput = document.getElementById('tx_amount');
            const txBoxInput = document.getElementById('tx_box');

            // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            txAmountInput.removeEventListener('input', validateTxAmount);
            txAmountInput.removeEventListener('blur', validateTxAmount);
            txBoxInput.removeEventListener('input', validateTxBox);
            txBoxInput.removeEventListener('blur', validateTxBox);

            // Ø¥Ø¶Ø§ÙØ© event listeners Ø¬Ø¯ÙŠØ¯Ø©
            txAmountInput.addEventListener('input', validateTxAmount);
            txAmountInput.addEventListener('blur', validateTxAmount);
            txBoxInput.addEventListener('input', validateTxBox);
            txBoxInput.addEventListener('blur', validateTxBox);

            (new bootstrap.Modal(document.getElementById('addTxModal'))).show();
        }

        let currentEditTransaction = null; // To store transaction being edited

        async function openEditTxModal(documentId) {
            if (!window.currentEmployee) return;

            // Fetch the specific transaction details
            const res = await fetch(`/api/employees/${encodeURIComponent(window.currentEmployee.id)}/transactions/${encodeURIComponent(documentId)}`);
            if (!res.ok) {
                console.error('Failed to fetch transaction for editing.', await res.text());
                return;
            }
            currentEditTransaction = await res.json();

            document.getElementById('edit_tx_documentId').value = currentEditTransaction.documentId;
            document.getElementById('edit_tx_type').value = currentEditTransaction.transactionType;
            document.getElementById('edit_tx_amount').value = currentEditTransaction.amount;
            document.getElementById('edit_tx_box').value = currentEditTransaction.boxNumber ?? '';
            document.getElementById('edit_tx_desc').value = currentEditTransaction.description ?? '';

            // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const editTxAmountInput = document.getElementById('edit_tx_amount');
            const editTxBoxInput = document.getElementById('edit_tx_box');

            // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
            editTxAmountInput.removeEventListener('input', validateEditTxAmount);
            editTxAmountInput.removeEventListener('blur', validateEditTxAmount);
            editTxBoxInput.removeEventListener('input', validateEditTxBox);
            editTxBoxInput.removeEventListener('blur', validateEditTxBox);

            // Ø¥Ø¶Ø§ÙØ© event listeners Ø¬Ø¯ÙŠØ¯Ø©
            editTxAmountInput.addEventListener('input', validateEditTxAmount);
            editTxAmountInput.addEventListener('blur', validateEditTxAmount);
            editTxBoxInput.addEventListener('input', validateEditTxBox);
            editTxBoxInput.addEventListener('blur', validateEditTxBox);

            new bootstrap.Modal(document.getElementById('editTxModal')).show();
        }

        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            if (!window.currentEmployee) return;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if (!validateEditName()) {
                alert('Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·');
                return;
            }

            if (!validateEditAge()) {
                alert('Ø§Ù„Ø¹Ù…Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');
                return;
            }

            const payload = {
                name: document.getElementById('edit_name').value.trim(),
                age: parseInt(document.getElementById('edit_age').value || '0'),
                address: document.getElementById('edit_address').value.trim(),
                identityType: document.getElementById('edit_identityType').value.trim(),
                identityName: document.getElementById('edit_identityName').value.trim(), // Keep identityName as it exists in the Employee model
                imageUrl: editUploadedImageUrl || window.currentEmployee.imageUrl || '' // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            };
            const res = await fetch(`/api/employees/${encodeURIComponent(window.currentEmployee.id)}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editEmployeeModal')).hide();
                playSound('edite.mp3'); // Play sound here
                // reload details
                loadEmployee(window.currentEmployee.id);
            }
        });

        document.getElementById('saveTxBtn').addEventListener('click', async () => {
            if (!window.currentEmployee) return;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if (!validateTxAmount()) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');
                return;
            }

            if (!validateTxBox()) {
                alert('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');
                return;
            }

            const payload = {
                transactionType: document.getElementById('tx_type').value,
                amount: parseFloat(document.getElementById('tx_amount').value || '0'),
                boxNumber: document.getElementById('tx_box').value.trim(),
                description: document.getElementById('tx_desc').value.trim()
            };
            const res = await fetch(`/api/employees/${encodeURIComponent(window.currentEmployee.id)}/transactions`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addTxModal')).hide();
                playSound('addCart.mp3'); // Play addCart.mp3 sound here
                // refresh transactions table
                loadEmployee(window.currentEmployee.id);
            }
        });

        document.getElementById('saveEditTxBtn').addEventListener('click', async () => {
            if (!window.currentEmployee || !currentEditTransaction) return;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            if (!validateEditTxAmount()) {
                alert('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');
                return;
            }

            if (!validateEditTxBox()) {
                alert('Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·');
                return;
            }

            const payload = {
                transactionType: document.getElementById('edit_tx_type').value,
                amount: parseFloat(document.getElementById('edit_tx_amount').value || '0'),
                boxNumber: document.getElementById('edit_tx_box').value.trim(),
                description: document.getElementById('edit_tx_desc').value.trim()
            };
            const res = await fetch(`/api/employees/${encodeURIComponent(window.currentEmployee.id)}/transactions/${encodeURIComponent(currentEditTransaction.documentId)}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editTxModal')).hide();
                playSound('edite.mp3'); // Play sound here
                loadEmployee(window.currentEmployee.id);
            }
        });

        // Function to open the transactions summary modal
        function openTxSummary() {
            // We assume the current transactions are rendered in the table; rebuild summary from rows
            const rows = Array.from(document.querySelectorAll('#searchContent table tbody tr'));
            const txs = rows.map(r => {
                const cells = r.querySelectorAll('td');
                return {
                    type: cells[0]?.innerText.trim() || '',
                    amount: parseFloat((cells[1]?.innerText.replace(/[^0-9.-]/g, '') || '0')) || 0,
                    time: cells[2]?.innerText.trim() || '',
                    box: cells[3]?.innerText.trim() || '',
                    desc: cells[4]?.innerText.trim() || ''
                };
            });

            const totalDeposits = txs.filter(t => t.type === 'Ø¥ÙŠØ¯Ø§Ø¹').reduce((s, t) => s + t.amount, 0);
            const totalWithdrawals = txs.filter(t => t.type === 'Ø³Ø­Ø¨').reduce((s, t) => s + t.amount, 0);
            const totalTransfers = txs.filter(t => t.type.includes('ØªØ­ÙˆÙŠÙ„')).reduce((s, t) => s + t.amount, 0);
            const grandTotal = txs.reduce((s, t) => s + t.amount, 0);

            const body = document.getElementById('txSummaryBody');
            body.innerHTML = `
                                                                                                    <div class="row text-center mb-3">
                                                                                                        <div class="col-md-3"><div class="p-2 border rounded bg-light"><strong>Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª:</strong> <span class="text-success">${totalDeposits.toLocaleString()} Ø¯.Ø£</span></div></div>
                                                                                                        <div class="col-md-3"><div class="p-2 border rounded bg-light"><strong>Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª:</strong> <span class="text-danger">${totalWithdrawals.toLocaleString()} Ø¯.Ø£</span></div></div>
                                                                                                        <div class="col-md-3"><div class="p-2 border rounded bg-light"><strong>Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª:</strong> <span>${totalTransfers.toLocaleString()} Ø¯.Ø£</span></div></div>
                                                                                                        <div class="col-md-3"><div class="p-2 border rounded bg-light"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</strong> <span class="fw-bold">${grandTotal.toLocaleString()} Ø¯.Ø£</span></div></div>
                                                                                                    </div>
                                                                                                    <div class="table-responsive">
                                                                                                        <table class="table table-sm table-striped">
                                                                                                            <thead class="table-dark">
                                                                                                                <tr>
                                                                                                                    <th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</th><th>Ø§Ù„ÙˆØµÙ</th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody>
                                                                                                                ${txs.map(t => `
                                                                                                                    <tr>
                                                                                                                        <td>${t.type}</td>
                                                                                                                        <td>${t.amount.toLocaleString()} Ø¯.Ø£</td>
                                                                                                                        <td>${t.time}</td>
                                                                                                                        <td>${t.box}</td>
                                                                                                                        <td>${t.desc}</td>
                                                                                                                    </tr>
                                                                                                                `).join('')}
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                                `;
            new bootstrap.Modal(document.getElementById('txSummaryModal')).show();
        }

        function playSound(filename) {
            const audio = new Audio(`/sounds/${filename}`);
            audio.play();
        }
    </script>
}

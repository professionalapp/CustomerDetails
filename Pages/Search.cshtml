@page
@model CustomerDetails.Pages.SearchModel
@{
    ViewData["Title"] = "ุจุญุซ ุนู ุนููู";
}

<div class="container mt-4 fade-in">
    <div class="row">
        <div class="col-12">
            <h1 class="text-center mb-4" style="color: #4C7EFF; font-family: 'Segoe UI', sans-serif;">
                ุจุญุซ ุนู ุนููู ๐
            </h1>
        </div>
    </div>

    <!-- ูุฑุจุน ุงูุจุญุซ ุงููุญุณู -->
    <div class="row mb-4">
        <div class="col-md-8 mx-auto">
            <div class="search-container">
                <input type="text" 
                       id="searchInput" 
                       class="search-input" 
                       placeholder="ุงุจุญุซ ุนู ุงูุนููู ุจุงูุงุณู ุฃู ุฑูู ุงููุนุฑู..." 
                       value="@Model.SearchId" 
                       autocomplete="off" />
                <i class="fas fa-search search-icon"></i>
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    ุงูุชุจ ุงุณู ุงูุนููู ุฃู ุฑูู ุงููุนุฑู ููุจุญุซ
                </small>
            </div>
        </div>
    </div>

    <!-- ุงููุชุงุฆุฌ -->
    <div class="row">
        <div class="col-12">
            <div id="searchContent">
                @if (string.IsNullOrEmpty(Model.SearchId))
                {
                    <!-- ุฑุณุงูุฉ ุชุฑุญูุจ ุนูุฏ ุนุฏู ูุฌูุฏ ุจุญุซ -->
                    <div class="text-center py-5">
                        <div class="search-welcome">
                            <i class="fas fa-search fa-4x text-muted mb-4"></i>
                            <h3 class="text-muted mb-3">ูุฑุญุจุงู ุจู ูู ูุธุงู ุงูุจุญุซ</h3>
                            <p class="text-muted mb-4">
                                ุงูุชุจ ุงุณู ุงูุนููู ุฃู ุฑูู ุงููุนุฑู ูู ุญูู ุงูุจุญุซ ุฃุนูุงู ููุนุซูุฑ ุนูู ุจูุงูุงุชู
                            </p>
                            <div class="search-features">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="feature-item">
                                            <i class="fas fa-user fa-2x text-primary mb-2"></i>
                                            <h5>ุงูุจุญุซ ุจุงูุงุณู</h5>
                                            <p class="text-muted">ุงุจุญุซ ุนู ุงูุนููู ุจุงุณุชุฎุฏุงู ุงุณูู</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="feature-item">
                                            <i class="fas fa-id-card fa-2x text-success mb-2"></i>
                                            <h5>ุงูุจุญุซ ุจุฑูู ุงููุนุฑู</h5>
                                            <p class="text-muted">ุงุจุญุซ ุนู ุงูุนููู ุจุงุณุชุฎุฏุงู ุฑูู ูุนุฑูู</p>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="feature-item">
                                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                            <h5>ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช</h5>
                                            <p class="text-muted">ุนุฑุถ ุฌููุน ุงูุจูุงูุงุช ูุงููุนุงููุงุช</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (Model.Customer != null)
                {
                    <!-- ุนุฑุถ ุงูุจูุงูุงุช ุนูุฏ ูุฌูุฏ ูุชุงุฆุฌ -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h3 class="mb-0">ุจูุงูุงุช ุงูุนููู ๐ค</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>ุฑูู ุงูุนููู:</strong><br>
                                    <span class="text-primary">@Model.Customer.Id</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงูุงุณู:</strong><br>
                                    <span>@Model.Customer.Name</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุงูุนูุฑ:</strong><br>
                                    <span>@Model.Customer.Age ุณูุฉ</span>
                                </div>
                                <div class="col-md-3">
                                    <strong>ุชุงุฑูุฎ ุงูุชุณุฌูู:</strong><br>
                                    <span>@Model.Customer.JoinDate.ToString("yyyy/MM/dd")</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (Model.Transactions.Any())
                    {
                        <div class="card mt-3">
                            <div class="card-header bg-success text-white">
                                <h4 class="mb-0 text-white">ุงููุนุงููุงุช ุงููุงููุฉ ๐ณ</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>ููุน ุงููุนุงููุฉ</th>
                                                <th>ุงููุจูุบ</th>
                                                <th>ุงูุชุงุฑูุฎ</th>
                                                <th>ุงูููุช</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var transaction in Model.Transactions)
                                            {
                                                <tr>
                                                    <td>
                                                        <span class="badge @(transaction.Type == "ุฅูุฏุงุน" ? "bg-success" : "bg-danger")">
                                                            @transaction.Type
                                                        </span>
                                                    </td>
                                                    <td class="@(transaction.Type == "ุฅูุฏุงุน" ? "text-success" : "text-danger") fw-bold">
                                                        @(transaction.Type == "ุฅูุฏุงุน" ? "+" : "-")@transaction.Amount.ToString("C")
                                                    </td>
                                                    <td>@transaction.Date.ToString("yyyy/MM/dd")</td>
                                                    <td>@transaction.Date.ToString("HH:mm")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <!-- ุฑุณุงูุฉ ุนุฏู ูุฌูุฏ ูุชุงุฆุฌ -->
                    <div class="alert alert-warning text-center">
                        <h4>ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู</h4>
                        <p>ูุง ููุฌุฏ ุนููู ุจูุฐุง ุงููุนุฑู: <strong>@Model.SearchId</strong></p>
                        <button type="button" class="btn btn-primary" onclick="clearSearch()">
                            <i class="fas fa-refresh"></i> ุจุญุซ ุฌุฏูุฏ
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let searchTimeout;
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchContent = document.getElementById('searchContent');

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุฅุฐุง ูุงู ุงููุต ูุงุฑุบุงู
            if (query.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            // ุฅูุบุงุก ุงูุจุญุซ ุงูุณุงุจู ุฅุฐุง ูุงู ููุฌูุฏุงู
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // ุชุฃุฎูุฑ ุงูุจุญุซ ูุชุญุณูู ุงูุฃุฏุงุก
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });


        // ุงูุจุญุซ ุนูุฏ ุงูุถุบุท ุนูู Enter
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query.length > 0) {
                    searchResults.style.display = 'none';
                    loadCustomerData(query);
                }
            }
        });

        // ุฅุฎูุงุก ุงููุชุงุฆุฌ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/search/customers?query=${encodeURIComponent(query)}`);
                const results = await response.json();
                
                displaySearchResults(results);
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุงูุจุญุซ:', error);
                searchResults.innerHTML = '<div class="no-results">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุจุญุซ</div>';
                searchResults.style.display = 'block';
            }
        }

        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="no-results">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>';
            } else {
                searchResults.innerHTML = results.map(customer => `
                    <div class="search-result-item" onclick="selectCustomer('${customer.id}')">
                        <div class="search-result-name">${customer.name}</div>
                        <div class="search-result-details">
                            ุฑูู ุงูุนููู: ${customer.id} | ุงูุนูุฑ: ${customer.age} ุณูุฉ | ุชุงุฑูุฎ ุงูุงูุถูุงู: ${customer.joinDate}
                        </div>
                    </div>
                `).join('');
            }
            searchResults.style.display = 'block';
        }

        function selectCustomer(customerId) {
            searchInput.value = customerId;
            searchResults.style.display = 'none';
            
            // ุงูุจุญุซ ุนู ุจูุงูุงุช ุงูุนููู ูุนุฑุถูุง ูุจุงุดุฑุฉ
            loadCustomerData(customerId);
        }

        function clearSearch() {
            searchInput.value = '';
            searchResults.style.display = 'none';
            
            // ุฅุนุงุฏุฉ ุนุฑุถ ุฑุณุงูุฉ ุงูุชุฑุญูุจ
            searchContent.innerHTML = `
                <div class="text-center py-5">
                    <div class="search-welcome">
                        <i class="fas fa-search fa-4x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">ูุฑุญุจุงู ุจู ูู ูุธุงู ุงูุจุญุซ</h3>
                        <p class="text-muted mb-4">
                            ุงูุชุจ ุงุณู ุงูุนููู ุฃู ุฑูู ุงููุนุฑู ูู ุญูู ุงูุจุญุซ ุฃุนูุงู ููุนุซูุฑ ุนูู ุจูุงูุงุชู
                        </p>
                        <div class="search-features">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="feature-item">
                                        <i class="fas fa-user fa-2x text-primary mb-2"></i>
                                        <h5>ุงูุจุญุซ ุจุงูุงุณู</h5>
                                        <p class="text-muted">ุงุจุญุซ ุนู ุงูุนููู ุจุงุณุชุฎุฏุงู ุงุณูู</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-item">
                                        <i class="fas fa-id-card fa-2x text-success mb-2"></i>
                                        <h5>ุงูุจุญุซ ุจุฑูู ุงููุนุฑู</h5>
                                        <p class="text-muted">ุงุจุญุซ ุนู ุงูุนููู ุจุงุณุชุฎุฏุงู ุฑูู ูุนุฑูู</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="feature-item">
                                        <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                        <h5>ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช</h5>
                                        <p class="text-muted">ุนุฑุถ ุฌููุน ุงูุจูุงูุงุช ูุงููุนุงููุงุช</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadCustomerData(customerId) {
            try {
                // ุฅุธูุงุฑ ูุคุดุฑ ุงูุชุญููู
                searchContent.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ุฌุงุฑู ุงูุชุญููู...</span>
                        </div>
                        <p class="mt-2">ุฌุงุฑู ุงูุจุญุซ ุนู ุจูุงูุงุช ุงูุนููู...</p>
                    </div>
                `;

                // ุงูุจุญุซ ุนู ุงูุนููู
                const response = await fetch(`/api/search/customers?query=${encodeURIComponent(customerId)}`);
                const customers = await response.json();
                
                if (customers.length > 0) {
                    const customer = customers.find(c => c.id === customerId) || customers[0];
                    await displayCustomerDetails(customer.id);
                } else {
                    searchContent.innerHTML = `
                        <div class="alert alert-warning text-center">
                            <h4>ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู</h4>
                            <p>ูุง ููุฌุฏ ุนููู ุจูุฐุง ุงููุนุฑู: <strong>${customerId}</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุนููู:', error);
                searchContent.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <h4>ุญุฏุซ ุฎุทุฃ</h4>
                        <p>ุชุนุฐุฑ ุชุญููู ุจูุงูุงุช ุงูุนููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.</p>
                    </div>
                `;
            }
        }

        async function displayCustomerDetails(customerId) {
            try {
                // ุฌูุจ ุจูุงูุงุช ุงูุนููู ูุงููุนุงููุงุช
                const [customerResponse, transactionsResponse] = await Promise.all([
                    fetch(`/api/search/customers?query=${encodeURIComponent(customerId)}`),
                    fetch(`/api/search/transactions?query=${encodeURIComponent(customerId)}`)
                ]);

                const customers = await customerResponse.json();
                const transactions = await transactionsResponse.json();

                if (customers.length > 0) {
                    const customer = customers.find(c => c.id === customerId) || customers[0];
                    
                    // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
                    const totalDeposits = transactions
                        .filter(t => t.type === 'ุฅูุฏุงุน')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const totalWithdrawals = transactions
                        .filter(t => t.type === 'ุณุญุจ')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    const balance = totalDeposits - totalWithdrawals;

                    // ุนุฑุถ ุจูุงูุงุช ุงูุนููู
                    searchContent.innerHTML = `
                        <!-- ูุนูููุงุช ุงูุนููู -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h3 class="mb-0 text-white">ูุนูููุงุช ุงูุนููู ๐ค</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>ุฑูู ุงูุนููู:</strong><br>
                                        <span class="text-primary">${customer.id}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ุงูุงุณู:</strong><br>
                                        <span>${customer.name}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ุงูุนูุฑ:</strong><br>
                                        <span>${customer.age} ุณูุฉ</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ุชุงุฑูุฎ ุงูุงูุถูุงู:</strong><br>
                                        <span>${customer.joinDate}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ุงูุฅุญุตุงุฆูุงุช ุงููุงููุฉ -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                    <h5>ุฅุฌูุงูู ุงูุฅูุฏุงุนุงุช</h5>
                                    <h3>${totalDeposits.toLocaleString()} ุฏ.ุฃ</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                                    <h5>ุฅุฌูุงูู ุงูุณุญูุจุงุช</h5>
                                    <h3>${totalWithdrawals.toLocaleString()} ุฏ.ุฃ</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stat-card" style="background: linear-gradient(135deg, ${balance >= 0 ? '#17a2b8 0%, #6f42c1 100%' : '#ffc107 0%, #fd7e14 100%'});">
                                    <h5>ุงูุฑุตูุฏ ุงูุญุงูู</h5>
                                    <h3>${balance.toLocaleString()} ุฏ.ุฃ</h3>
                                </div>
                            </div>
                        </div>

                        <!-- ูุนุงููุงุช ุงูุนููู -->
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h4 class="mb-0 text-white">ุณุฌู ุงููุนุงููุงุช ๐ณ</h4>
                            </div>
                            <div class="card-body">
                                ${transactions.length > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>ููุน ุงููุนุงููุฉ</th>
                                                    <th>ุงููุจูุบ</th>
                                                    <th>ุงูุชุงุฑูุฎ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${transactions.map(transaction => `
                                                    <tr>
                                                        <td>
                                                            <span class="badge ${transaction.type === 'ุฅูุฏุงุน' ? 'bg-success' : 'bg-danger'} fs-6">
                                                                ${transaction.type}
                                                            </span>
                                                        </td>
                                                        <td class="${transaction.type === 'ุฅูุฏุงุน' ? 'text-success' : 'text-danger'} fw-bold">
                                                            ${transaction.type === 'ุฅูุฏุงุน' ? '+' : '-'}${transaction.amount.toLocaleString()} ุฏ.ุฃ
                                                        </td>
                                                        <td>${transaction.date}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : `
                                    <div class="text-center py-4">
                                        <p class="text-muted">ูุง ุชูุฌุฏ ูุนุงููุงุช ููุฐุง ุงูุนููู</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                } else {
                    searchContent.innerHTML = `
                        <div class="alert alert-warning text-center">
                            <h4>ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนููู</h4>
                            <p>ูุง ููุฌุฏ ุนููู ุจูุฐุง ุงููุนุฑู: <strong>${customerId}</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ุฎุทุฃ ูู ุนุฑุถ ุจูุงูุงุช ุงูุนููู:', error);
                searchContent.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <h4>ุญุฏุซ ุฎุทุฃ</h4>
                        <p>ุชุนุฐุฑ ุนุฑุถ ุจูุงูุงุช ุงูุนููู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.</p>
                    </div>
                `;
            }
        }
    </script>
}